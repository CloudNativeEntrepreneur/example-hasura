apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: example-hasura-postgresql
spec:
  teamId: example

  numberOfInstances: 1

  users:
    admin:  # database owner
    - superuser
    - createdb
    hasura: []

  # format:
  # `${databasename}: ${owner}` (matches user ^)
  databases:
    hasura: hasura

  enableShmVolume: true
  enableLogicalBackup: false
  enableConnectionPooler: false
  enableReplicaConnectionPooler: false

  # connectionPooler:
  #   maxDBConnections: {{ .Values.hasura.psql.connectionPooler.maxDBConnections }}
  #   numberOfInstances: {{ .Values.hasura.psql.connectionPooler.numberOfInstances }}

  postgresql:
    version: "13"
    parameters:
      # parameters generated by [pgtune](https://pgtune.leopard.in.ua/#/) based on resources and number of connections:
      # --------
      # DB Version: 13
      # OS Type: linux
      # DB Type: web
      # Total Memory (RAM): 512 MB
      # CPUs num: 1
      # Connections num: 115
      # Data Storage: ssd

      # must use strings!
      # max_connections should probably match psql.maxDBConnections + 15 for other various connections ^
      # if changing connections or resources, make sure to "retune".
      max_connections: "115"
      shared_buffers: 128MB
      effective_cache_size: 384MB
      maintenance_work_mem: 32MB
      checkpoint_completion_target: "0.9"
      wal_buffers: 3932kB
      default_statistics_target: "100"
      random_page_cost: "1.1"
      effective_io_concurrency: "200"
      work_mem: 569kB
      min_wal_size: 1GB
      max_wal_size: 4GB

  resources:
    requests:
      cpu: 10m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 512Mi

  volume:
    size: 8Gi